Goal (incl. success criteria):
- Support SmartBadminton documentation/tasks while enforcing rule set (esp. technical/design docs) and keeping ledger current.

Constraints/Assumptions:
- Must always apply rule documents under `C:\Users\yasuo\Desktop\SmartBadminton\rule`.
- Continuity ledger must be maintained per instructions.
- Begin each reply with a brief “Ledger Snapshot” (Goal + Now/Next + Open Questions).
- Work exclusively within `C:\Users\yasuo\Desktop\SmartBadminton` workspace.
- Replies must be in Vietnamese.
- Do not run DB/migration/server commands autonomously; request user execution when needed.
- When user provides the Implementation/Task/TDD structure from rule, that is approval to proceed.

Key decisions:
- Ledger/rule compliance established; registration TDD + task breakdown completed.
- Requirements locked: user stories, validation rules, API contract, data model (refresh_tokens/login_audit), JWT/BCrypt, rate limiting; reCAPTCHA out-of-scope.
- Architecture fixed: MVC structure under `backend/{prisma,src(config|middleware|modules|routes|shared),tests}`.
- Implementation delivered for Tasks 1–20 (schema, config, middleware, services, routes, docs, tests) plus Docker stack.
- JWT uses asymmetric keys and `jsonwebtoken` (CommonJS-friendly); env vars documented.

State:
  - Done:
    - All rule docs reviewed; TDD + task breakdown completed for registration flow.
    - Implemented Tasks 1–20 (schema, config, middleware, services, routes, docs) plus unit/integration/contract tests.
    - Added backend Dockerfile and docker-compose for local stack.
    - Switched JWT helper to `jsonwebtoken`.
    - Rewrote `project_overview.md` with deeper detail per `project-overview-rule.mdc`.
    - Drafted login TDD at `TDD/login-tdd.md`.
    - Created login task breakdown at `task/login-task-breakdown.md`.
    - Added `LOGIN` to `AuditAction` enum in `backend/prisma/schema.prisma` (Task 1).
    - Added login validator schema in `backend/src/modules/auth/validators/login.validator.ts` (Task 3).
    - Completed Task 2 (Prisma migration + generate, user-run) and Task 4 (validateLoginPayload helper).
    - Added login route in `backend/src/routes/auth.routes.ts` (Task 5).
    - Attached rate limit middleware to login route (Task 6).
    - Added login controller handler in `backend/src/modules/auth/controllers/auth.controller.ts` (Task 7).
    - Wired login controller to validator/service and ServiceError mapping (Task 8).
    - Added ZodError handling for login payload validation (Task 9).
    - Verified `createLoginAudit` repository helper already exists (Task 10).
    - Verified `createRefreshToken` repository helper already exists (Task 11).
    - Implemented login service with validation, token issuance, and audit persistence (Tasks 12-17).
    - Added login metrics counters/histogram in `backend/src/shared/metrics.ts` (Task 18).
    - Added structured login logs in `backend/src/modules/auth/services/auth.service.ts` (Task 19).
    - Updated OpenAPI spec with login endpoint in `docs/api/auth.yaml` (Task 20).
    - Added OpenAPI error examples for login in `docs/api/auth.yaml` (Task 21).
    - Read `rule/continuity-ledger-rule.mdc` and will apply it on every request.
    - Added DB connection check on server start in `backend/src/app.ts` with success/failure logging.
    - Read `docs/CNM.pdf` spec and reviewed registration API for alignment.
    - Updated login validation to require non-empty fields and adjusted login errors to match spec messages.
    - Drafted TDD for available courts at `TDD/available-courts-tdd.md` based on `docs/CNM.pdf`.
    - Added codebase alignment section to `TDD/available-courts-tdd.md`.
    - Created detailed task breakdown at `task/available-courts-task-breakdown.md` from the available-courts TDD.
    - Completed Task 1: added `CourtType` enum to `backend/prisma/schema.prisma`.
    - Completed Task 2: added `BookingStatus` enum to `backend/prisma/schema.prisma`.
    - Completed Task 3: added `Court` model to `backend/prisma/schema.prisma`.
    - Completed Task 4: added `Booking` model and relation to `Court` in `backend/prisma/schema.prisma`.
    - Chose Option A: `Booking` keeps `startTime`/`endTime` as `DateTime` and removes `date`.
    - Completed Task 5: added booking availability index on (`courtId`, `startTime`, `endTime`, `status`).
    - Completed Task 8: created `backend/src/routes/court.routes.ts`.
    - Completed Task 9: registered `/api/courts` routes in `backend/src/app.ts`.
    - Completed Task 10: added auth middleware in `backend/src/middleware/auth.ts`.
    - Completed Task 11: added role-based middleware helper in `backend/src/middleware/auth.ts`.
    - Completed Task 12: added `available-courts.validator.ts` for query validation.
    - Completed Task 13: date format validation included in available courts validator.
    - Completed Task 14: time format validation included in available courts validator.
    - Completed Task 15: startTime < endTime validation included in available courts validator.
    - Completed Task 16: operating hours validation (06:00-23:00) included in available courts validator.
    - Completed Task 17: created `backend/src/modules/courts/repositories/court.repository.ts`.
    - Completed Task 18: availability query implemented in court repository.
    - Completed Task 19: overlap logic uses `startTime < end` and `endTime > start`.
    - Completed Task 20: created `backend/src/modules/courts/services/available-courts.service.ts`.
    - Completed Task 21: durationMinutes computed in available courts service.
    - Completed Task 22: NO_AVAILABLE_COURTS error thrown when no results.
    - Completed Task 23: created `backend/src/modules/courts/controllers/court.controller.ts`.
    - Completed Task 24: handler uses `responseMiddleware` in courts controller.
    - Completed Task 25: validation and service error mapping handled in courts controller.
    - Completed Task 26: wired `/api/courts/available` with auth + role in `court.routes.ts`.
    - Completed Task 27: added structured logs for available courts search and results.
    - Completed Task 28: added available courts metrics and wired service timings/counters.
    - Completed Task 37: added OpenAPI spec for courts at `docs/api/courts.yaml`.
    - Completed Task 38: added error examples (400/401/403/404) in `docs/api/courts.yaml`.
    - Completed Task 39: updated `docs/ops.md` with available courts logs/metrics.
    - Completed Task 40: updated TDD with p95 target (300ms) and confirmed blocking statuses.
    - Added seed script for `Court`/`Booking` at `backend/prisma/seed.ts` and wired `prisma:seed` in `backend/package.json`.
    - Created backend Dockerfile at `infra/Docker/Dockerfile.BE`.
    - Added bind mount for backend in `infra/docker-compose.yml`.
    - Removed bind mount entries from `infra/docker-compose.yml` per user request.
    - Updated `project_overview.md` to match latest codebase per `project-overview-rule.mdc`.
  - Now:
    - Ready for remaining tests or any follow-up tasks.
  - Next:
    - Proceed with remaining tasks you request.

Open questions (`UNCONFIRMED` if needed):
- None.

Working set (files/ids/commands):
- `rule/continuity-ledger-rule.mdc`
- `rule/implementation-rule.mdc`
- `rule/project-overview-rule.mdc`
- `rule/task-breakdown-rule.mdc`
- `rule/technical-design-documentation-rule.mdc`
- `CONTINUITY.md`
- `project_overview.md`
- `docs/CNM (1).pdf`
- `TDD/login-tdd.md`
- `task/login-task-breakdown.md`
- `backend/prisma/schema.prisma`
- `backend/src/modules/auth/validators/login.validator.ts`
- `backend/src/modules/auth/services/auth.service.ts`
- `docs/api/auth.yaml`
- `backend/src/shared/metrics.ts`
- `backend/src/modules/auth/services/auth.service.ts`
